System.currentTimeMillis()

file\:/C://Users/v1014352/Downloads/gradle-8.9-bin.zip



com.epay.merchant.exception.MerchantException: Invalid Captcha.. Reason : Captcha Expired, Invalid Request	


- Report Scheduler need to create which need to be run in every 30 min time and read the data from REPORT_SCHEDULER_MANAGMENT
- As per Data recived from Table it need to insert the record in Report Managmenet table for report creation and push the event to Kafka for report generation

@EqualsAndHashCode(callSuper = true)
@Data
@Entity
@Table(name = "REPORT_MANAGEMENT")
public class ReportManagement extends AuditEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    @Column(name = "ID", nullable = false, updatable = false, unique = true)
    private UUID id;

    private UUID reportId;

    @Column(name="MID")
    private String mId;

    private Long durationFromDate;
    private Long durationToDate;
    @Enumerated(EnumType.STRING)
    private ReportFormat format;
    @Enumerated(EnumType.STRING)
    private ReportStatus status;
    private String filePath;
    private String remarks;
    private UUID scheduledId;

}

@EqualsAndHashCode(callSuper = true)
@Data
@Entity
@Table(name = "REPORT_SCHEDULE_MANAGEMENT")
public class ReportScheduleManagement extends AuditEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    @Column(name = "ID", nullable = false, updatable = false, unique = true)
    private UUID id;

    private UUID reportId;
    
    @Column(name="MID")
    private String mId;

    @Enumerated(EnumType.STRING)
    private Frequency frequency;
    @Enumerated(EnumType.STRING)
    private ReportFormat format;

    private String scheduleExecutionTime;
    private Long nextScheduleExecutionTime;
    private Long lastScheduleExecutionTime;

    @Enumerated(EnumType.STRING)
    private ReportScheduledStatus status;

 }
here I've to get all ReportScheduleManagement data and check status of it it's is TO_BE_START then need to pick that data and update lastScheduleExecutionTime as currentTime and but we have to pick those data which's nextScheduleExecutionTime 
is ahead 30 minitues when shceduler is calling and every behind data which one's status is TO_BE_START and update data in ReportManagement and insert scheduledId as ReportScheduleManagement id and update ReportScheduleManagement table.










.......................::::::..........::::::.....

@Service
public class ReportScheduler {

    @Autowired
    private ReportScheduleManagementRepository reportScheduleManagementRepository;

    @Autowired
    private ReportManagementRepository reportManagementRepository;

    @Scheduled(fixedRate = 1800000) // 30 minutes in milliseconds
    public void scheduleReportGeneration() {
        long currentTime = System.currentTimeMillis();
        long thirtyMinutesAhead = currentTime + 30 * 60 * 1000;

        // Fetch the data
        List<ReportScheduleManagement> schedulesToProcess = reportScheduleManagementRepository
                .findByStatusAndNextScheduleExecutionTime("TO_BE_START", currentTime, thirtyMinutesAhead);

        for (ReportScheduleManagement schedule : schedulesToProcess) {
            processSchedule(schedule);
        }
    }

    private void processSchedule(ReportScheduleManagement schedule) {
        long currentTime = System.currentTimeMillis();

        // Update lastScheduleExecutionTime
        schedule.setLastScheduleExecutionTime(currentTime);

        // Create new ReportManagement record
        ReportManagement report = new ReportManagement();
        report.setReportId(schedule.getReportId());
        report.setMId(schedule.getMId());
        report.setDurationFromDate(calculateDurationFromDate(schedule)); // Add logic for duration calculation
        report.setDurationToDate(calculateDurationToDate(schedule));
        report.setFormat(schedule.getFormat());
        report.setStatus(ReportStatus.PENDING);
        report.setScheduledId(schedule.getId());

        // Save to ReportManagement table
        reportManagementRepository.save(report);

        // Update ReportScheduleManagement status
        schedule.setStatus(ReportScheduledStatus.IN_PROGRESS);
        reportScheduleManagementRepository.save(schedule);
    }

    private Long calculateDurationFromDate(ReportScheduleManagement schedule) {
        // Logic to calculate durationFromDate based on schedule or current context
        return System.currentTimeMillis() - 86400000; // Example: 1 day before current time
    }

    private Long calculateDurationToDate(ReportScheduleManagement schedule) {
        // Logic to calculate durationToDate based on schedule or current context
        return System.currentTimeMillis(); // Example: current time
    }
}